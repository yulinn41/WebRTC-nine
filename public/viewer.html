<!-- public/viewer.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Viewer</title>
  <link rel="stylesheet" href="/client.css" />
</head>
<body>
  <h2>Viewer</h2>

  <h3>選擇觀看對象</h3>
  <div id="btnGroup" class="grid"></div>

  <video id="remoteVideo" autoplay playsinline></video>
  <p id="status"></p>

<script>
const statusEl = document.getElementById("status");
const btnGroup = document.getElementById("btnGroup");
const remoteVideo = document.getElementById("remoteVideo");

function log(s){ statusEl.textContent = s; console.log(s); }

const viewerId = "viewer-" + Math.random().toString(36).slice(2, 8);
const ws = new WebSocket(`wss://${location.host}`);

function wsSend(to, payload) {
  ws.send(JSON.stringify({ type: "relay", to, payload }));
}

const ICE_SERVERS = [{ urls: "stun:stun.l.google.com:19302" }];

let pc = null;
let targetId = null;

ws.onopen = () => {
  ws.send(JSON.stringify({ type: "register", id: viewerId, role: "viewer" }));
  log(`已註冊：${viewerId}，等待線上清單…`);
};

ws.onmessage = async (ev) => {
  const msg = JSON.parse(ev.data);

  if (msg.type === "registered") return;

  // 伺服器同步在線 peer 清單
  if (msg.type === "peerList") {
    const allPeers = ["A1","A2","B1","B2","C1","C2","D1","D2"];
    btnGroup.innerHTML = "";
    allPeers.forEach(id => {
      const online = msg.peers.includes(id);
      const btn = document.createElement("button");
      btn.textContent = id;
      btn.disabled = !online;
      btn.onclick = () => startWatch(id);
      btnGroup.appendChild(btn);
    });

    // 若目前觀看目標離線了，提示並關閉
    if (targetId && !msg.peers.includes(targetId)) {
      log(`${targetId} 已離線`);
      targetId = null;
      if (pc) { pc.close(); pc = null; }
      remoteVideo.srcObject = null;
    }
    return;
  }

  // 對應目標的回覆/候選
  if (msg.type === "relay" && msg.payload) {
    const p = msg.payload;
    if (p.from === targetId) {
      if (p.kind === "answer" && pc) {
        await pc.setRemoteDescription(new RTCSessionDescription(p.sdp));
        log(`已接收 ${targetId} Answer，開始播放`);
      }
      if (p.kind === "candidate" && pc && p.candidate) {
        try { await pc.addIceCandidate(p.candidate); } catch {}
      }
    }
    return;
  }

  if (msg.type === "peerOffline") {
    log(`目標 ${msg.to} 不在線`);
  }
};

async function startWatch(id) {
  targetId = id;
  log(`請求觀看：${id}`);

  if (pc) pc.close();
  pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

  pc.ontrack = (e) => {
    remoteVideo.srcObject = e.streams[0];
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      wsSend(targetId, { kind: "candidate", candidate: e.candidate });
    }
  };

  // 僅接收（不送本機）
  pc.addTransceiver("video", { direction: "recvonly" });

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // 轉給目標 peer
  wsSend(targetId, { kind: "viewerOffer", sdp: offer });
}
</script>
</body>
</html>
